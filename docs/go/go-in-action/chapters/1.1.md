第一章 Go语言介绍
=================

本章解决如下问题:
1. 使用Go语言解决现代计算挑战
2. 使用go命令

计算机已经进化了，但是编程语言并没有跟上进化步伐。我们携带的手机都可以拥有比我们使用的第一台电脑更多的核。高功率服务器现在都有64，128甚至更高的核，但是我们仍然使用过去我们使用的单核技术来编程。

编程艺术也进化了。 很多程序也不再由单个开发者实现的了: 由坐在不同时区不同时间的团队成员实现。大项目被拆分成小片分配给程序员，然后由程序员将他们的工作以类库或包的形式传回团队, 而且这些类库和包可以跨越应用的整个包可用。

当今的程序员和公司比以往更相信开源软件的强大。Go是一种让代码分享变得更容易的语言。Go附带工具可以使得使用其他人写的包变得更简单，Go也更加容易共享自己的包。

本章你会看到Go和其他语言的不同之处。Go反思你可能使用的传统面向对象开发, 同时仍然提供有效的代码复用方式。Go更容易有效使用你的昂贵服务器的多核特性，这样能大大降低大型项目的编译代价。

阅读本章的过程中，你会感觉到Go的创造适合很多决定，从它的并发模型到快速编译。我们在序言中有提到过，但值得重复: 本书是为具有一些其他编程语言经验并且想学Go语言的中级开发人员所写。我们写本书的目标是为你提供强化、全面和真实的语言观。我们专注于语言规范和实现，包括语言语法、Go类型系统、并发、通道、测试等多方面的主题。我们相信本书对于那些想要跳跃性学习Go语言或者希望彻底理解语言和其内核的人都是完美的。

我们希望你能欣赏Go自带的工具可以让开发者的生活变得更轻松。最后，你会明白为什么那么多开发者在新项目的时候会选择Go。

## 1.1 使用Go语言来解决现代编程挑战

Go语言团队竭尽全力解决当今软件开发所面临的问题。为项目选择语言时，开发者在快速开发和性能之间苦苦挣扎。类似C/C++这样的语言执行效率高，而类似Ruby/Python之类的语言开发效率高。Go语言为这矛盾世界提供了桥梁， 它是一种高效语言同时还让开发变得快速。

在我们探索的过程中，你会发现精心设计的特性和简洁的语法。作为一个语言，Go不仅仅被定义它包含什么，而且定义不包含什么。Go语言具有简洁语法，需要记住很少的关键词。Go语言有如此高效的编译器，有时候你会忘记它在运行。作为一名Go开发者，你会明显花费更少的时间用于构建项目。因为Go语言内置并发特性，软件将来扩展使用可用资源无需强制你使用特殊的线程库。Go使用简单有效的类型系统，而类型系统占用面向对象开发的大量开销, 让你更加专注代码复用。Go语言也有垃圾回收器，因此你无需管理自己的内存。下面我们快速看看这些关键特性。

### 1.1.1 Development speed
在C/C++中编译大型应用程序花费时间要比获取一杯咖啡要多很多。下面图1.1展示了办公室鬼混的经典借口XKCD漫画。Go语言通过使用智能编译器和简化依赖解析算法提供了快如闪电般的编译。当构建Go程序时，编译器只需要查找你直接引用的库，而无需遍历类似Java, C/C++中整个依赖链中所有引入库的依赖。

因此，很多Go应用程序在图1.1下编译还会有难度? 另外，整个Go源码树在现代硬件上编译都在20秒以下。

![](images/1.1.jpg?raw=true)

> 领导喊程序员赶紧工作，程序员借口代码正在编译, 领导只能说继续吧。

### 1.1.2 并发
对于程序员来说，最难的是编写一个能有效利用运行它的硬件的有效资源的应用。现代计算机都有很多核，但是很多编程语言没有有效工具可以很容易利用这些额外资源。它们通常需要大量线程同步代码，这样很容易出错。

Go的并发支持是它最强大特性之一。Goroutine类似线程，但是比线程使用更少内存，使用更少的代码。通道是数据结构，允许你使用内置同步在goroutine之间发送类型消息。这样有利于在goroutine之间发送数据的编程模型，而不用让groutine抢用相同的数据。现在让我们更详细地看看这些特性。

**GOROUTINE**

goroutine是与其他goroutine一起运行的功能，包括程序的入口点。在其他语言中，使用线程来完成同样的事情，但是在Go语言中，很多goroutine可以在同一个线程中执行。例如，如果你写了一个web服务器，你要同时处理很多不同的web请求，在C或Java中就需要使用线程写大量额外代码。而在go语言中，net/http库都内置有goroutine。每个入站请求都自动运行在它自己的goroutine中。Goroutine比线程使用更少的内存, 并且Go运行时会根据配置的逻辑处理器来自动调度goroutine的执行。每个逻辑处理器被绑定到单个OS线程。 这样你的应用程序就大大减少开发工作量，效率却更加明显提高。

![](images/1.2.jpg?raw=true)

如果你想要并行执行一些代码，同时继续完成其他的事情，goroutine是完美胜任的。下面是一个快速例子:
```
func log(msg string){
    ... some logging code here
}
// Elsewhere in our code after we've discovered an error.
go log("something dire happened")
```

关键词go是你想要调度log函数以goroutine的形式运行的全部，并且对于这个goroutine会和其他goroutine同时运行。这就意味着你可以继续执行应用程序的其他代码，而logging并行发生，这最终往往能为你的终端用户感觉更大的性能提升。 如前所述，goroutine具有最小的开销，因此它产生成千上万的都没有什么不正常。我们在第六章会探讨goroutine和并发更深入的东西。

**Channel**

通道是数据结构，能在goroutine之间安全的进行数据传输。通道能帮你避免那些允许共享内存访问编程语言中常见的经典问题。

并发最难的部分就是确保数据不被并行运行的进程、线程或goroutine意外的修改。当多线程没有使用锁或同步时修改相同的数据时，心痛总是伴随着的。其他语言中，当你有全局变量或共享内存的时候，需要使用复杂的锁定准则来防止对相同变量的非同步改变。

![](images/1.3.jpg?raw=true)

通道通过提供一种使数据安全免受并行修改的模式来解决这个问题。通道帮助强制在同一时间只能有一个goroutine修改数据的模式。在图1.3中你可以看到这个流程的例子，通道用于在多个运行的goroutine之间发送数据。想象一个应用程序里边有很多不同的进程需要知道或修改数据的顺序。使用goroutine和通道，你可以安全的模拟这个过程。

在图1.3中，有三个goroutine和两个未缓冲的通道。第一个goroutine通过一个channel传递数据给第二个已在等待的goroutine. 两个goroutine之间的数据交换是同步的，一旦发生切换，两个goroutine都知道交换发生了。在第二个goroutine使用数据执行它的任务之后，然后将数据发送给第三个正在等待的goroutine。 交换也是同步的，两个goroutine都能保证交换已经发生。 goroutine之间的数据安全交换不需要其他锁或同步机制。

需要注意的是，通道不提供goroutine之间的数据访问保护。 如果数据拷贝通过通道交换，那么每个goroutine都有它的一份拷贝，可以安全的对数据进行更改。 当指向数据的指针被交换, 如果读写在不同的goroutine间进行，那么每个goroutine仍然需要被同步。

### 1.1.3 Go语言的类型系统
Go语言提供了灵活的无层次类型系统，它能够以最小的重构开销实现代码复用。它仍然是面向对象开发，但是没有传统面向对象的头痛问题。如果你曾在复杂的Java或C++程序中花费一个星期来计划你的抽象类和接口, 你会感激Go语言的类型系统的简单性。Go语言开发人员只需要用一种叫做组合的设计模式嵌入类型来复用功能。其他语言中使用组合，但通常和继承紧密绑定， 这样就变得复杂、难以使用。 在Go语言中，类型由更小的类型组成，这点是与传统基于继承的模型相悖的。

另外Go具有独特的接口实现，允许你建模行为，而不是建模类型。在Go语言中你无需声明正在实现一个接口, 编译器帮你做这个事情，它来决定你的类型值是否满足使用的接口。在Go语言标准库中很多接口都非常小，仅仅暴露很少的功能。 在实践中，这需要时间来适应，特别是你习惯使用类似Java这样的面相对象语言。

**类型简单**

Go语言不仅有内置类型(比如int, string), 它还有用户自定义类型。Go语言中典型的用户自定义类型有用于存储数据的类型字段。如果你见过C语言中的结构体，Go语言中的用户自定义类型看起来和它类似，操作也类似。 但是类型也可以声明操作数据的方法。与其构建长的继承结构体Client, 扩展User, 扩展Entity, Go开发者选择构建更小的类型Customer和Admin，然后将它们嵌入到一个大集合中。图1-4演示了继承和组合的区别。

![](images/1.4.jpg?raw=true)

**GO语言接口建模小的行为**
接口允许你表达类型的行为。如果某个类型的值实现了一个接口，则意味着该值具有特定的行为集。你甚至不需要声明实现了某个接口, 你只需要写实现。其他语言称这种模式为鸭子模式--如果叫起来像鸭子，那么它就可以是一个鸭子--Go语言就很好的实现了它。 在Go语言中，如果类型实现了某个接口的方法，那么这个类型的值可以存储在那个接口类型的值里边。无需特殊声明。

在比如Java这样严格的面相对象语言中, 接口是包罗万象的。甚至在能开始编码之前，通常都需要思考庞大的继承链。下面是一个Java接口的示例:

```
interface User {
    public void login();
    public void logout();
}
```

在Java中要实现这个接口, 你需要创建一个类满足所有User接口作出的承诺和明确声明你实现这个接口。与之相比，Go语言接口一般代表的只是单独的行为。在Go语言中, 你将使用的最常见接口之一就是io.Reader。io.Reader接口提供了一个简单的方法，声明您的类型具有以标准库中的其他函数理解的方式读取的数据。下面是定义:
```
type Reader interface {
    Read(p []byte) (n int, err error)
}
```

要写一个实现io.Reader接口的类型，只需要实现一个Read方法，接受一个字节分片，并返回一个整数和可能的错误即可。

这与其他面相对象编程语言中使用的接口系统完全背离。 Go语言的接口更小，更符合单一职责。在实践中，让代码复用和可组合性极具优势。您几乎可以为任意有可用数据的类型实现io.Reader, 然后将其传递给任意知道如何从io.Reader读取的Go函数。Go语言中整个网络库都是使用io.Reader接口构建，因为它允许将不同的网络操作所需的网络实现与应用程序的功能分开。它使接口有趣、优雅、灵活。 同样的io.Reader允许简单的文件、缓冲区、套接字以及其他数据源的操作。 使用单个接口允许你有效的进行数据操作，而不用管源如何。

### 1.1.4 内存管理

不当的内存管理会导致应用程序崩溃或内存泄漏，甚至导致操作系统奔溃。 Go语言拥有现代的垃圾回收器，可以帮你解决那些难事。 其他系统语言(例如C/C++), 使用内存之前，需要分配一片内存, 不用的时候还需要释放它们。 如果分配或释放某处发生失败，都会引发程序崩溃或内存泄漏。 通常都不太容易跟踪不再需要使用的内存片。线程和重并发的时候就更难了。

想象一下，使用带有垃圾回收的语言写代码时，虽然Go语言的垃圾回收增加了程序执行时间的开销，但是很显著的降低了开发的难度。Go语言只需单调编程，数豆子的事情让计数器去干。

## 1.2 Hello, Go
实战中看编程语言会更加有感觉。下面我们看看Go语言实现的传统的Hello World!应用:

```
// Go程序以包组织代码
package main
import "fmt" // import语句允许你引入外部代码。 fmt包由标准库提供，允许你格式化输出数据。
func main(){ // main函数是在应用程序运行的时候执行， 类似于C语言中的main。
   fmt.Println("Hello World!")
}
```

这个例子在运行后会在屏幕打印那个熟悉的词语。 但是如何运行它呢? 如果电脑上没有安装Go，通过浏览器也能使用Go提供的几乎所有的功能。

### 1.2.1 介绍Go Playground

Go Playground允许你在浏览器中编辑和运行Go代码。 启动浏览器，导航到http://play.golang.org, 屏幕中浏览器中的代码是可编辑的。点击运行，看看会发生什么！

You can even change the code to make the greeting text output in a different language. Go ahead and change the greeting inside the fmt.Println() function and hit Run again.

SHARING GO CODE Go developers use the Playground to share code ideas, test theories, and debug their code, as you soon will too. Every time you create a new application on the Playground, you can click Share to get a sharable URL that anyone else can open. Try this one: http://play.golang.org/p/EWIXicJdmz.

The Go Playground is the perfect way to demonstrate an idea to a coworker or friend who’s trying to learn something, or to solicit help. On the Go IRC channels, Slack group, mailing lists, and countless emails sent among Go developers, you’ll see Go Playground programs being created, modified, and shared.

## 总结

1. Go语言是现代的、快速的、带有强大标准库的语言。
2. Go语言有内置并发。
3. Go使用接口作为代码复用的构建块。

## 中英文对照 
- 强化、全面和真实的语言观: intensive, comprehensive, and idiomatic view of the language
- 竭尽全力: go to great lengths
- 办公室鬼混经典借口: classic excuse for messing around in the office
- XKCD: 由兰德尔·门罗（Randall Munroe）创作的网络漫画
- 快如闪电: lightning-quick
- 并发: Concurrency
- 切换: hand-off
- 无层次: hierarchy-free
- 包罗万象: all-encompassing

## 链接
- [目录](../README.md)
- [下一节](2.1.md)
